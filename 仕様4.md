# p2psns - 仕様書 v4（現行実装）

## プロジェクト概要

**p2psns** は Ruby + WEBrick で実装された P2P 分散型 SNS。各ノードは独立して動作し、ユーザはローカルユーザディレクトリで管理される。投稿はユーザ別に分散保存され、テーマ・フォントサイズ・レイアウトをカスタマイズ可能。

## システムアーキテクチャ

### サーバ構成
- **HTTP サーバ**: WEBrick（ポート 8000 デフォルト）
- **要件**: Ruby 2.5+、stdlib のみ（OpenSSL, JSON, ERB, FileUtils, Net/HTTP）

### ディレクトリ構造
```
users/
├── template/                    # ユーザ作成時のテンプレート
│   └── data/
│       ├── config.json          # デフォルト設定
│       ├── followers.json       # (未使用)
│       ├── posts.json           # 初期空配列
│       └── profile.json         # テンプレートプロフィール
├── {username}/                  # ユーザ専用ディレクトリ
│   ├── data/
│   │   ├── config.json          # ユーザ設定（テーマ、フォントサイズ等）
│   │   ├── followers.json
│   │   ├── posts.json           # ユーザの投稿一覧
│   │   └── profile.json         # ユーザプロフィール（公開鍵、ユーザ名等）
│   ├── media/
│   └── pmedia/
public/
├── css/
│   └── theme.css                # テーマ CSS（デフォルト・ダーク）
views/
├── form.erb                     # ログイン / サインアップフォーム
├── home.erb                     # ホームタイムライン（ローカル投稿）
├── config.erb                   # ユーザ設定ページ
```

## 認証・セッション管理

### 流れ
1. **サインアップ** (`/signup` POST)
   - ユーザディレクトリ作成（template クローン）
   - RSA-2048 鍵ペア生成（秘密鍵は AES-256-CBC で暗号化）
   - profile.json へ保存
   - セッション ID 生成、クッキー発行

2. **ログイン** (`/` POST)
   - profile.json から秘密鍵を読込
   - 秘密鍵の復号に入力パスワードを使用（認証）
   - 成功時、セッション ID 生成、クッキー発行

3. **セッション管理**
   - グローバル `$sessions` ハッシュにセッション ID → ユーザ情報をマッピング
   - クッキー `session_id` で識別
   - ローカル開発のため `secure = false` に設定（HTTP で送信可）

## エンドポイント

| エンドポイント | メソッド | 認証 | 説明 |
|---|---|---|---|
| `/` | GET | — | ログインフォーム表示 |
| `/` | POST | — | ログイン処理 |
| `/signup` | GET | — | サインアップフォーム表示 |
| `/signup` | POST | — | ユーザ登録処理 |
| `/home` | GET | 必須（session_id） | ローカル投稿タイムライン表示 |
| `/global` | GET | 必須 | リモート投稿タイムライン表示（Network.fetch_posts） |
| `/post` | POST | 必須 | 投稿送信（ローカル保存） |
| `/config` | GET | 必須 | ユーザ設定ページ表示 |
| `/config` | POST | 必須 | 設定変更・保存処理 |
| `/latest_posts` | GET | — | JSON: 最新 20 件投稿（ローカル + リモート統合） |
| `/logout` | GET | — | ログアウト（セッション削除、トップへリダイレクト） |
| `/public/*` | GET | — | 静的ファイル（CSS 等）配信 |

## データ構造

### profile.json
```json
{
  "username": "kipo",
  "public_key": "-----BEGIN PUBLIC KEY-----\n...",
}
```

### config.json
```json
{
  "theme": "default",           // "default" または "dark"
  "layout": "default",          // "default" または "advanced"
  "fontSize": "medium",         // "small", "medium", "large"
  "showMedia": true,
  "notifications": {
    "enable": true,
    "enableOnDesktop": true
  },
  "visibility": "public"        // "public", "friends", "private"
}
```

### posts.json
```json
[
  {
    "username": "kipo",
    "message": "Hello, p2psns!",
    "time": "2025-12-05 10:30:45 +0900"
  },
  ...
]
```

## テーマ・UI システム

### CSS テーマ (`public/css/theme.css`)
- **Bootstrap 5.3.2 CDN** をベース
- **クラスベース切り替え**:
  - `body.theme-default`: 白背景、標準カラー
  - `body.theme-dark`: 黒背景（#1a1a1a）、高コントラスト
- **フォントサイズ**:
  - `body.font-small`: 0.875rem
  - `body.font-medium`: 1rem（デフォルト）
  - `body.font-large`: 1.125rem
- **レイアウト**:
  - `body.layout-default`: 標準 3 カラム（投稿 / フィード / ナビ）
  - `body.layout-compact`: コンパクト版（余白削減）
  - `body.layout-advanced`: カスタム列幅

### 動的テーマ適用
テンプレート側で `config` を読込、`body` タグに動的クラスを付与：
```erb
<body class="theme-<%= config['theme'] || 'default' %> font-<%= config['fontSize'] || 'medium' %> layout-<%= config['layout'] || 'default' %>">
```

## P2P / ノード間通信

### Network モジュール
- `Network.load_nodes(path = 'nodes.json')`: `nodes.json` からノード URL 一覧を読込
- `Network.fetch_posts`: 各リモートノードの `/latest_posts` から投稿を取得

### nodes.json 形式
```json
[
  "http://localhost:8001",
  "http://localhost:8002"
]
```

### 実装状況
- **ローカル投稿保存**: ✅ 完成
- **リモート投稿取得**: ✅ 実装中（他ノード`/latest_posts` にGETで実装予定）
- **ゴシッププロトコル**: ⚠️ 未実装（フォロワーのデータのレプリカを保存するなら要るか...？）
- **無限ループ防止**: ⚠️ 検討中(正直セキュリティ・エラーハンドリング周りはよくわからんので時間掛かる)

## ストレージ層

### Storage クラス
```ruby
def self.load_posts
  # 全ユーザの posts.json を集約、時系列でソート
end

def self.save_post(post)
  # 単一投稿をユーザ別 posts.json に追記
end

def self.load_config(username)
  # users/{username}/data/config.json を読込
end

def self.save_config(username, changes)
  # config.json を更新・保存（既存設定とマージ）
end
```

## 既知の問題 / 改善点

1. ~~**パスワード保存**: profile.json に平文で保存 → ハッシュ化推奨~~
2. **セッション永続化**: メモリ内のみ（サーバ再起動で消滅） → ファイル保存推奨
3. **ゴシッププロトコル**: 実装が空のため、ノード間ブロードキャストが未実装
4. **無限ループ防止**: リモート同期で同じポストが重複する可能性あり → ID / タイムスタンプチェック推奨
5. **暗号署名**: RSA 鍵生成は済むが、投稿の署名・検証未実装
6. **メディア処理**: `media/` / `pmedia/` フォルダはテンプレートで作成されるが利用なし
7. **フォロワー機能**: `followers.json` は作成されるが未実装

## 開発・運用

### サーバ起動
```bash
ruby server.rb              # ポート 8000 でスタート
ruby server.rb 8001        # カスタムポート指定
ruby server.rb --debug     # デバッグモード（ログ詳細化）
```

### テスト
- 手動ブラウザテストが中心
- `test/` フォルダには参考ドキュメント（~~`GossipTest.md`~~, `NetworkTest.md` 等）

## 今後の拡張予定

1. ゴシッププロトコルの完全実装（ノード間ブロードキャスト）
2. ~~パスワードハッシュ化（bcrypt 推奨）~~
3. セッション管理
4. 投稿への暗号署名・検証
5. フォロワー / フォロイー機能
6. メディア（画像・動画）アップロード対応
7. リアルタイム通知（WebSocket）
8. ユーザ検索 / ハッシュタグ

---

**更新日**: 2025-12-05  
**バージョン**: 4  
**ステータス**: 基本機能完成、P2P 機能開発中
