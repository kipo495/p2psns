### P2P型SNSの設計全体像

### データ設計

#### 識別子・鍵・署名
- **ユーザーID:** 公開鍵の指紋（例: ECDSA/secp256k1のSHA-256）をユーザーIDに採用。
- **署名:** すべての更新系イベントとポストのメタデータにユーザー署名を付与。
- **暗号化:** DMや限定公開は受信者の公開鍵に対する暗号化を併用。

#### 更新系データ（イベントログ＋CRDT）
- **イベントストア:** フォロー/アンフォロー、プロフィール更新、ブロック、設定変更などを「不変イベント」の時系列ログで表現。  
  - **フィールド:** event_type, actor_id, payload, lamport_ts, vector_clock(optional), prev_hash, signature。
- **CRDT採用:** 競合が起きる可能性があるフィールド（プロフィールの各キー、リスト構造）は LWW-Register（最後に書いたもの勝ち）や OR-Set を適用。  
- **スナップショット:** ノード起動時の適用時間短縮のため、定期的にイベントを圧縮しスナップショットを配布。

#### ポスト（コンテンツアドレス化＋バージョニング）
- **本体:** バイナリ/テキストをチャンク化し、各チャンクのハッシュをブロックIDに。  
- **メタデータ:** post_id(content_hash), author_id, created_at, parent_ref(replies), thread_ref, visibility, media_refs, signature。  
- **編集:** 新バージョンは新しい content_hash。post_idは「メタデータの恒久ID＋最新版ポインタ」で管理。  
- **削除/非表示:** Tombstoneイベントで論理削除。ポリシーによりGC対象に。

#### インデックス・参照構造
- **タイムライン:** ユーザーのホームは「フォロー集合の最新ポスト参照リスト（post_idのOR-Set）」を保持。  
- **検索:** 軽量全文検索はローカルのみ。グローバルはタグ/DHTキー検索に限定。  
- **タグ/ハッシュタグ:** tag_name をキーに DHT で最新インデックスブロックを参照。

#### 保持ポリシー・GC
- **レプリカ係数:** 投稿は k（例: 5–7）を目標に近傍＋フォロワー＋閲覧者キャッシュで確保。  
- **人気バイアス:** キャッシュの TTL をアクセス頻度で延長。  
- **暗号化コンテンツ:** 受信者以外はブロック保持可だが中身は読めない。必要に応じて暗号化ブロックのGCを短めに。

---

### ネットワークの調整

#### ルーティング・発見
- **DHT:** Kademliaベースでキー空間を共有（ユーザーID、タグ、post meta pointers）。  
- **近傍選定:** RTT/帯域/信頼度スコアで近傍集合を定期更新。

#### 伝搬戦略（Gossipの範囲）
- **更新系データ:** 全ノードではなく、以下に限定。  
  - **ソーシャル近傍:** 自分のフォロワー、相互フォロー、コミュニティ・タグ近傍。  
  - **DHT責任ノード:** ユーザーIDの責務範囲ノードへプッシュ＋pull。  
  - **アンチエントロピー:** 定期的にチェックサム交換で欠落イベントを補完。
- **ポスト:**  
  - **初期レプリカ:** 投稿時に近傍 k ノードへレプリケート。  
  - **キャッシュ伝搬:** 閲覧時にチャンクを取得したノードが一定期間保持。  
  - **フォロワーミラー:** フォロワーは最新 N 件を自動ミラー（Nはユーザー設定＋ディスク上限）。

#### 整合性・スパム耐性
- **レート制御:** Gossip送信はトークンバケットで制限。  
- **署名検証:** 未署名・無効署名は破棄。  
- **評判スコア:** 迷惑行為検出（過剰送信、重複、無関係タグ濫用）で近傍からの距離を増やす。  
- **ブロックリスト:** ユーザー単位・コミュニティ単位で伝搬するブロックイベント。

#### 可用性・オフライン耐性
- **ストア＆フォワード:** オフライン期間のイベントをローカルにキュー、復帰時にまとめてGossip。  
- **遅延受容:** タイムラインは「確定済み＋遅延中」表示を分け、後から整合する。  
- **保全監査:** レプリカ係数が閾値未満のポストを定期的に検出して再レプリケート。

---

### ページデザイン

#### 体験の前提
- **可視性:** 分散と遅延を前提に、ロード状態、部分欠落、再取得の手段を明示。  
- **編集履歴:** 投稿の改版は履歴として辿れるUI。  
- **信頼指標:** 署名アイコン、作者鍵指紋、レプリカ状態の軽量表示。

#### 主要画面
- **ホームタイムライン:**  
  - **フィード:** 確定済みポストと遅延中ポストを分けて表示。  
  - **フィルタ:** フォロワー/タグ/コミュニティ別。  
- **プロフィール:**  
  - **最新スナップショット＋イベント差分**を表示。  
  - **鍵管理:** 公開鍵指紋、認証バッジ（Web-of-Trust風）。  
- **投稿詳細:**  
  - **レプリカ状態:** 保持ノード数、キャッシュTTL、編集履歴。  
  - **返信ツリー:** スレッド参照で再構築、欠落には再取得ボタン。  
- **設定:**  
  - **レプリカ上限/キャッシュTTL/ミラー件数**をユーザーが調整。  
  - **ネットワーク:** 近傍選定方針、帯域上限。

---

### 設定実装

#### ユーザー設定項目
- **ストレージ:** レプリカ係数上限、フォロワーミラー件数、メディア最大サイズ。  
- **帯域:** 送受信レート、Gossip間隔、バックグラウンド同期可否。  
- **プライバシー:** DMの暗号化必須、限定公開の再配布可否、メタデータ縮減。  
- **モデレーション:** ブロック/ミュート、タグフィルタ、評判閾値。  
- **信頼:** キーのローテーション、デバイス追加、Web-of-Trustの承認。

#### ノード設定（運用向け）
- **近傍選定:** RTT閾値、信頼スコア重み。  
- **DHT:** kバケットサイズ、リプライタイムアウト。  
- **保全:** 保全監査周期、再レプリケーションのバッチサイズ。  
- **ログ:** 監査イベント、署名失敗、ドロップ理由。

---

### 実装マイルストーンと検証

1. **鍵・署名・イベントログの基礎**  
   - **成果:** ユーザー登録、署名付き更新イベント、スナップショット生成。
2. **DHT＋近傍選定の実装**  
   - **成果:** ユーザーID/タグ/ポストポインタの解決、RTTベース近傍。
3. **Gossipの限定伝搬**  
   - **成果:** ソーシャル近傍＋責任ノードへの更新配布、アンチエントロピー。
4. **ポストのコンテンツアドレス化＋チャンク化**  
   - **成果:** チャンクストア、レプリカ係数維持、閲覧キャッシュ。
5. **タイムライン再構築＋遅延許容UI**  
   - **成果:** 欠落再取得、編集履歴、レプリカ表示。
6. **スパム耐性・評判・ブロック**  
   - **成果:** レート制御、評判スコア、コミュニティブロックイベント。
7. **保全監査・GC・バックアップ**  
   - **成果:** レプリカ不足検知、Tombstone処理、暗号化コンテンツ方針。
8. **負荷試験・障害試験**  
   - **成果:** ノード離脱/ネット分断/高負荷時の可用性と遅延の測定。

---

## 用語の説明

- ユーザID
ハッシュ化は「公開鍵＝ID」にする設計のために提案したもの。ですが「Twitterのように自由に決めるID」を採用するなら、衝突回避のために 登録時にDHTでユニーク性チェックすればOK。公開鍵は内部的に認証用に保持し、ユーザが使うのは自由ID。
- CRDT
軽量なものなら LWW-Register（最後に書いたもの勝ち） や OR-Set（集合の追加/削除） が基本。プロフィールやフォロー関係ならこれで十分。
- ブロック機能
必須ではない。完全P2P型SNSを成立させるために「最低限必要」ではなく、モデレーション機能の一種。今回は省略してOK。
- ポリシー
ネットワークやストレージの「保持ルール」。例: 投稿は最低kノードに複製する、キャッシュはTTLで消す、など。
- GC（Garbage Collection）
古くなったデータや不要になったキャッシュを削除する仕組み。ストレージが無限ではないので必要になる。
- チャンク
大きな投稿（画像や動画）を分割して保存する単位。小さいブロックに分けて分散保持することで効率化。
- ローカルタイムライン
近傍ノードの投稿をリアルタイムに表示するフィード。グローバルな「フォロータイムライン」とは別。
- トークンバケット
ネットワーク制御の仕組み。一定量の「トークン」をバケットに貯めておき、送信するたびに消費。トークンがないと送信できない。これで送信レートを制御できる。
- オフライン時のキュー
→ 送信側の話。自分がオフラインの間に発生したイベントをローカルに溜めておき、復帰時にまとめてGossipで送信する。
- タイムラインの「確定済み」「遅延」
- 確定済み: レプリカ数が十分で、整合性が保証されている投稿。
- 遅延: まだ伝搬中で、近傍から取得しただけの投稿。後で整合性が取れる可能性がある。
- 閾値
具体的には「レプリカ数が最低k以上あるかどうか」などの基準値。例: 投稿は最低3ノードに保持されていれば「確定済み」とみなす。
