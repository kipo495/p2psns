# Gossipプロトコル テスト手順

## セットアップ

1. **nodes.json を編集** - 既知のノードリストを定義
   ```json
   [
     "localhost:8000",
     "localhost:8001"
   ]
   ```

2. **複数のノードを起動**
   ```bash
   # ターミナル1: ノード1 (port 8000)
   ruby server.rb    #default=8000
   
   # ターミナル2: ノード2 (port 8001)
   ruby server.rb 8001
   ```

## テストシナリオ

### シナリオ1: ローカルで投稿してブロードキャスト

1. ノード1 にアクセス: `http://localhost:8000`
2. ログイン/新規登録してホーム画面へ
3. 投稿を作成 (例: "Hello from Node 1")
4. `/post` エンドポイントが自動的に `Gossip.broadcast()` を呼び出す
5. ノード2 (`http://localhost:8001`) をリロードして、同じ投稿が見えることを確認

### シナリオ2: ノード間での相互同期

1. ノード1 で投稿 → ノード2 に自動同期されることを確認
2. ノード2 で投稿 → ノード1 に自動同期されることを確認
3. コンソールログで `[Gossip]` メッセージを確認

## ロギング

### 送信側（ノード1）
```
[Gossip] broadcasting to: ["localhost:8001"]
```

### 受信側（ノード2）
```
[Routes] /gossip received: {"type"=>"post", "payload"=>{"user"=>"...", ...}}
[Routes] /gossip post saved: {"user"=>"...", "message"=>"...", "time"=>"..."}
```

## トラブルシューティング

- **接続失敗**: ファイアウォール設定を確認、ポート 8000/8001 が開いているか確認
- **無限ループ**: `/gossip` エンドポイントで再度 `Gossip.broadcast()` を呼んでいないか確認
- **投稿が同期されない**: `nodes.json` がノードリストに正しいホストポートを含んでいるか確認

## 今後の改善

- [ ] 配信失敗の履歴を記録・監視
- [ ] キューイングシステムで非同期ワーカー化
- [ ] メッセージ署名（RSA）で改ざん防止
- [ ] ノード登録/削除の管理エンドポイント
- [ ] 分散トランザクションでの競合解決
